<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SIGEB - Livros</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
    }
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 250px;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      padding: 20px;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    .sidebar-header {
      padding: 20px 0;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .sidebar-header h3 {
      background: linear-gradient(90deg, #00f2fe, #4facfe);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      font-weight: 600;
    }
    .menu-items {
      padding: 20px 0;
    }
    .menu-item {
      padding: 12px 20px;
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
      border-radius: 8px;
      margin-bottom: 5px;
    }
    .menu-item:hover, .menu-item.active {
      background: rgba(255, 255, 255, 0.1);
      color: #4facfe;
    }
    .menu-item i {
      margin-right: 10px;
      font-size: 1.2rem;
    }
    .main-content {
      margin-left: 250px;
      padding: 20px;
      transition: all 0.3s ease;
    }
    .page-header {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .book-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .book-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }
    .book-card:hover {
      transform: translateY(-5px);
    }
    .book-status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      margin-top: 10px;
    }
    .status-disponivel {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .status-emprestado {
      background: #ffebee;
      color: #c62828;
    }
    .add-button {
      background: linear-gradient(90deg, #00f2fe, #4facfe);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    .add-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .search-box {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      margin-bottom: 20px;
    }
    .search-box input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    .genre-filter {
      max-width: 200px;
      background-color: white;
    }
    .genre-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    .genre-badge {
      background: var(--accent-gradient);
      color: white;
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
    }
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .main-content {
        margin-left: 0;
      }
      .sidebar.active {
        transform: translateX(0);
      }
      .book-grid {
        grid-template-columns: 1fr;
      }
      .search-box {
        grid-template-columns: 1fr;
      }
      .genre-filter {
        max-width: 100%;
      }
    }
    .modal-content {
      border: none;
      border-radius: 15px;
    }
    .modal-header {
      background: var(--primary-gradient);
      color: white;
      border-radius: 15px 15px 0 0;
      border-bottom: none;
    }
    .modal-header .btn-close {
      filter: brightness(0) invert(1);
    }
    .modal-title {
      font-weight: 600;
    }
    .form-label {
      font-weight: 500;
      color: #1a1a2e;
    }
    .form-control, .form-select {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 15px;
      transition: var(--transition);
    }
    .form-control:focus, .form-select:focus {
      border-color: #4facfe;
      box-shadow: 0 0 0 0.2rem rgba(79, 172, 254, 0.25);
    }
    .cover-preview-container {
      position: relative;
      cursor: pointer;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .cover-upload-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      opacity: 0;
      transition: var(--transition);
    }
    .cover-preview-container:hover .cover-upload-overlay {
      opacity: 1;
    }
    .cover-upload-overlay i {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    #imagemCapa {
      display: none;
    }
    .btn-primary {
      background: var(--accent-gradient);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
    .text-muted {
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>SIGEB</h3>
    </div>
    <div class="menu-items">
      <a href="dashboard.html" class="menu-item">
        <i class='bx bxs-dashboard'></i>
        Dashboard
      </a>
      <a href="livros.html" class="menu-item active">
        <i class='bx bxs-book'></i>
        Livros
      </a>
      <a href="usuarios.html" class="menu-item">
        <i class='bx bxs-user'></i>
        Usuários
      </a>
      <a href="emprestimos.html" class="menu-item">
        <i class='bx bxs-bookmark'></i>
        Empréstimos
      </a>
      <a href="configuracoes.html" class="menu-item">
        <i class='bx bxs-cog'></i>
        Configurações
      </a>
      <a href="index.html" class="menu-item">
        <i class='bx bxs-log-out'></i>
        Sair
      </a>
    </div>
  </div>

  <div class="main-content">
    <div class="page-header">
      <div>
        <h2>Gerenciamento de Livros</h2>
        <p>Gerencie o acervo da biblioteca</p>
      </div>
      <button class="add-button" data-bs-toggle="modal" data-bs-target="#addBookModal">
        <i class='bx bx-plus'></i>
        Adicionar Livro
      </button>
    </div>

    <div class="search-box">
      <input type="text" placeholder="Pesquisar por título, autor ou ISBN...">
      <select class="form-select genre-filter" id="genreFilter">
        <option value="">Todos os Gêneros</option>
        <option value="ROMANCE">Romance</option>
        <option value="FICCAO_CIENTIFICA">Ficção Científica</option>
        <option value="FANTASIA">Fantasia</option>
        <option value="MISTERIO">Mistério</option>
        <option value="TERROR">Terror</option>
        <option value="DRAMA">Drama</option>
        <option value="AVENTURA">Aventura</option>
        <option value="BIOGRAFIA">Biografia</option>
        <option value="HISTORIA">História</option>
        <option value="CIENCIAS">Ciências</option>
        <option value="TECNOLOGIA">Tecnologia</option>
        <option value="AUTOAJUDA">Autoajuda</option>
        <option value="EDUCACAO">Educação</option>
        <option value="INFANTIL">Infantil</option>
        <option value="POESIA">Poesia</option>
        <option value="OUTROS">Outros</option>
      </select>
      <button class="add-button">
        <i class='bx bx-search'></i>
      </button>
    </div>

    <div class="book-grid">
      <div class="book-card">
        <h4>Dom Casmurro</h4>
        <p>Machado de Assis</p>
        <p><small>ISBN: 9788535910682</small></p>
        <span class="book-status status-disponivel">Disponível</span>
      </div>
      <div class="book-card">
        <h4>O Pequeno Príncipe</h4>
        <p>Antoine de Saint-Exupéry</p>
        <p><small>ISBN: 9788574123745</small></p>
        <span class="book-status status-emprestado">Emprestado</span>
      </div>
      <div class="book-card">
        <h4>1984</h4>
        <p>George Orwell</p>
        <p><small>ISBN: 9788535914849</small></p>
        <span class="book-status status-disponivel">Disponível</span>
      </div>
      <div class="book-card">
        <h4>Memórias Póstumas de Brás Cubas</h4>
        <p>Machado de Assis</p>
        <p><small>ISBN: 9788535911121</small></p>
        <span class="book-status status-disponivel">Disponível</span>
      </div>
    </div>

    <!-- Modal Adicionar Livro -->
    <div class="modal fade" id="addBookModal" tabindex="-1" aria-labelledby="addBookModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addBookModalLabel">Adicionar Novo Livro</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="addBookForm" class="needs-validation" novalidate>
              <div class="row">
                <div class="col-md-8">
                  <div class="mb-3">
                    <label for="titulo" class="form-label">Título*</label>
                    <input type="text" class="form-control" id="titulo" required>
                    <div class="invalid-feedback">
                      Por favor, insira o título do livro.
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="autores" class="form-label">Autor(es)*</label>
                    <input type="text" class="form-control" id="autores" required>
                    <small class="text-muted">Separe múltiplos autores com ponto e vírgula (;)</small>
                    <div class="invalid-feedback">
                      Por favor, insira pelo menos um autor.
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="editora" class="form-label">Editora*</label>
                    <input type="text" class="form-control" id="editora" required>
                    <div class="invalid-feedback">
                      Por favor, insira a editora.
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="anoPublicacao" class="form-label">Ano de Publicação*</label>
                        <input type="number" class="form-control" id="anoPublicacao" 
                               min="1800" max="2024" required
                               placeholder="Ex: 2024">
                        <div class="invalid-feedback">
                          Por favor, insira um ano válido (1800-2024).
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="edicao" class="form-label">Edição</label>
                        <input type="number" class="form-control" id="edicao" min="1">
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="isbn" class="form-label">ISBN*</label>
                        <input type="text" class="form-control" id="isbn" required 
                               pattern="^(?:ISBN(?:-1[03])?:? )?(?=[0-9X]{10}$|(?=(?:[0-9]+[- ]){3})[- 0-9X]{13}$|97[89][0-9]{10}$|(?=(?:[0-9]+[- ]){4})[- 0-9]{17}$)(?:97[89][- ]?)?[0-9]{1,5}[- ]?[0-9]+[- ]?[0-9]+[- ]?[0-9X]$">
                        <div class="invalid-feedback">
                          Por favor, insira um ISBN válido.
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="quantidade" class="form-label">Quantidade*</label>
                        <input type="number" class="form-control" id="quantidade" min="1" required>
                        <div class="invalid-feedback">
                          Por favor, insira a quantidade.
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="generos" class="form-label">Gêneros*</label>
                    <select class="form-select" id="generos" multiple required>
                      <option value="ROMANCE">Romance</option>
                      <option value="FICCAO_CIENTIFICA">Ficção Científica</option>
                      <option value="FANTASIA">Fantasia</option>
                      <option value="MISTERIO">Mistério</option>
                      <option value="TERROR">Terror</option>
                      <option value="DRAMA">Drama</option>
                      <option value="AVENTURA">Aventura</option>
                      <option value="BIOGRAFIA">Biografia</option>
                      <option value="HISTORIA">História</option>
                      <option value="CIENCIAS">Ciências</option>
                      <option value="TECNOLOGIA">Tecnologia</option>
                      <option value="AUTOAJUDA">Autoajuda</option>
                      <option value="EDUCACAO">Educação</option>
                      <option value="INFANTIL">Infantil</option>
                      <option value="POESIA">Poesia</option>
                      <option value="OUTROS">Outros</option>
                    </select>
                    <small class="text-muted">Pressione Ctrl (Cmd no Mac) para selecionar múltiplos gêneros</small>
                    <div class="invalid-feedback">
                      Por favor, selecione pelo menos um gênero.
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="idioma" class="form-label">Idioma*</label>
                    <select class="form-select" id="idioma" required>
                      <option value="">Selecione o idioma</option>
                      <option value="pt-BR">Português (Brasil)</option>
                      <option value="en">Inglês</option>
                      <option value="es">Espanhol</option>
                      <option value="fr">Francês</option>
                      <option value="de">Alemão</option>
                      <option value="it">Italiano</option>
                    </select>
                    <div class="invalid-feedback">
                      Por favor, selecione o idioma.
                    </div>
                  </div>
                </div>

                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="imagemCapa" class="form-label">Imagem da Capa</label>
                    <div class="cover-preview-container">
                      <img id="coverPreview" src="https://via.placeholder.com/200x300?text=Capa+do+Livro" 
                           class="img-fluid mb-2 rounded" alt="Preview da capa">
                      <div class="cover-upload-overlay">
                        <i class='bx bx-upload'></i>
                        <span>Clique para upload</span>
                      </div>
                    </div>
                    <input type="file" class="form-control" id="imagemCapa" accept="image/*" 
                           onchange="previewCover(this)">
                    <small class="text-muted">Formato: JPG, PNG. Tamanho máx: 2MB</small>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" form="addBookForm" class="btn btn-primary">Salvar Livro</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCkttFoV_FoPn91ClE7xFiknFvs9pXaCoQ",
      authDomain: "sigeb-ccd3f.firebaseapp.com",
      databaseURL: "https://sigeb-ccd3f-default-rtdb.firebaseio.com",
      projectId: "sigeb-ccd3f",
      storageBucket: "sigeb-ccd3f.firebasestorage.app",
      messagingSenderId: "209689711066",
      appId: "1:209689711066:web:5a99505e60bd34f29b70e3",
      measurementId: "G-VJBDW2B7HZ"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Function to handle book submission
    async function handleBookSubmission(event) {
      event.preventDefault();
      
      const form = document.getElementById('addBookForm');
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }

      try {
        // Show loading state
        const submitButton = document.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...';
        submitButton.disabled = true;

        // Get form data
        const bookData = {
          titulo: document.getElementById('titulo').value,
          autores: document.getElementById('autores').value.split(';').map(autor => autor.trim()),
          editora: document.getElementById('editora').value,
          anoPublicacao: parseInt(document.getElementById('anoPublicacao').value),
          isbn: document.getElementById('isbn').value,
          idioma: document.getElementById('idioma').value,
          edicao: document.getElementById('edicao').value || null,
          quantidade: parseInt(document.getElementById('quantidade').value),
          generos: Array.from(document.getElementById('generos').selectedOptions).map(option => option.value),
          dataCadastro: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Handle image upload if present
        const imageFile = document.getElementById('imagemCapa').files[0];
        if (imageFile) {
          const imageRef = storage.ref().child(`capas/${bookData.isbn}_${Date.now()}`);
          await imageRef.put(imageFile);
          bookData.imagemUrl = await imageRef.getDownloadURL();
        }

        // Save to Firestore
        await db.collection('livros').add(bookData);

        // Show success message
        showAlert('success', 'Livro adicionado com sucesso!');
        
        // Reset form and close modal
        form.reset();
        document.getElementById('coverPreview').src = 'https://via.placeholder.com/200x300?text=Capa+do+Livro';
        bootstrap.Modal.getInstance(document.getElementById('addBookModal')).hide();
        
        // Refresh book list
        loadBooks();

      } catch (error) {
        console.error('Erro ao salvar livro:', error);
        showAlert('danger', 'Erro ao salvar o livro. Por favor, tente novamente.');
      } finally {
        // Reset button state
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
      }
    }

    // Function to load books from Firebase
    async function loadBooks() {
      try {
        const bookGrid = document.querySelector('.book-grid');
        bookGrid.innerHTML = '<div class="loading-spinner">Carregando...</div>';

        let query = db.collection('livros').orderBy('dataCadastro', 'desc');
        
        // Apply genre filter if selected
        const selectedGenre = document.getElementById('genreFilter').value;
        if (selectedGenre) {
          query = query.where('generos', 'array-contains', selectedGenre);
        }

        const snapshot = await query.get();
        
        if (snapshot.empty) {
          bookGrid.innerHTML = '<p class="text-center">Nenhum livro encontrado.</p>';
          return;
        }

        bookGrid.innerHTML = '';
        snapshot.forEach(doc => {
          const book = doc.data();
          const bookCard = document.createElement('div');
          bookCard.className = 'book-card';
          bookCard.innerHTML = `
            <div class="book-cover">
              <img src="${book.imagemUrl || 'https://via.placeholder.com/200x300?text=Sem+Capa'}" 
                   alt="Capa do livro ${book.titulo}" class="img-fluid">
            </div>
            <h4>${book.titulo}</h4>
            <p>${book.autores.join(', ')}</p>
            <p><small>ISBN: ${book.isbn}</small></p>
            <p><small>Ano: ${book.anoPublicacao}</small></p>
            <div class="genre-badges">
              ${book.generos.map(genre => `<span class="genre-badge">${formatGenre(genre)}</span>`).join('')}
            </div>
            <span class="book-status ${book.quantidade > 0 ? 'status-disponivel' : 'status-emprestado'}">
              ${book.quantidade > 0 ? `${book.quantidade} disponível(is)` : 'Indisponível'}
            </span>
          `;
          bookGrid.appendChild(bookCard);
        });

      } catch (error) {
        console.error('Erro ao carregar livros:', error);
        showAlert('danger', 'Erro ao carregar os livros. Por favor, recarregue a página.');
      }
    }

    // Function to show alerts
    function showAlert(type, message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      document.body.appendChild(alertDiv);
      setTimeout(() => alertDiv.remove(), 5000);
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize AOS
      AOS.init({
        duration: 800,
        once: true,
        offset: 50
      });

      // Mobile sidebar toggle
      const toggleSidebar = () => {
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');
        if (window.innerWidth <= 768) {
          sidebar.classList.toggle('active');
          mainContent.style.marginLeft = sidebar.classList.contains('active') ? '250px' : '0';
        }
      };

      if (window.innerWidth <= 768) {
        const header = document.querySelector('.page-header');
        const hamburger = document.createElement('button');
        hamburger.className = 'btn btn-primary d-md-none mb-3';
        hamburger.innerHTML = '<i class="bx bx-menu"></i>';
        hamburger.onclick = toggleSidebar;
        header.prepend(hamburger);
      }

      // Form submission handler
      const form = document.getElementById('addBookForm');
      form.addEventListener('submit', handleBookSubmission);

      // Cover preview handler
      const coverContainer = document.querySelector('.cover-preview-container');
      const fileInput = document.getElementById('imagemCapa');
      coverContainer.addEventListener('click', () => fileInput.click());

      // Load initial books
      loadBooks();

      // Add genre filter change handler
      document.getElementById('genreFilter').addEventListener('change', loadBooks);
    });

    // Cover preview function
    function previewCover(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('coverPreview').src = e.target.result;
        }
        reader.readAsDataURL(input.files[0]);
      }
    }

    // Add helper function to format genre names
    function formatGenre(genre) {
      const genreMap = {
        'ROMANCE': 'Romance',
        'FICCAO_CIENTIFICA': 'Ficção Científica',
        'FANTASIA': 'Fantasia',
        'MISTERIO': 'Mistério',
        'TERROR': 'Terror',
        'DRAMA': 'Drama',
        'AVENTURA': 'Aventura',
        'BIOGRAFIA': 'Biografia',
        'HISTORIA': 'História',
        'CIENCIAS': 'Ciências',
        'TECNOLOGIA': 'Tecnologia',
        'AUTOAJUDA': 'Autoajuda',
        'EDUCACAO': 'Educação',
        'INFANTIL': 'Infantil',
        'POESIA': 'Poesia',
        'OUTROS': 'Outros'
      };
      return genreMap[genre] || genre;
    }
  </script>
</body>
</html> 