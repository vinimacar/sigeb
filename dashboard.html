<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGEB - Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- CSS personalizado -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="icone.png" type="image/png">
</head>
<body>
    <!-- Barra de navegação superior -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <img src="logobias.png" alt="SIGEB Logo" class="me-2">
                <span>SIGEB</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="livros.html"><i class="fas fa-book"></i> Livros</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="emprestimos.html"><i class="fas fa-exchange-alt"></i> Empréstimos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="usuarios.html"><i class="fas fa-users"></i> Usuários</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="relatorios.html"><i class="fas fa-chart-bar"></i> Relatórios</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="inventario.html"><i class="fas fa-boxes"></i> Inventário</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle"></i> <span id="userName">Usuário</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="configuracoes.html"><i class="fas fa-cog"></i> Configurações</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Conteúdo principal -->
    <div class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar de navegação (visível apenas em telas maiores) -->
            <div class="col-lg-3 col-xl-2 d-none d-lg-block">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">Menu</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            <a href="dashboard.html" class="list-group-item list-group-item-action active">
                                <i class="fas fa-home me-2"></i> Dashboard
                            </a>
                            <a href="livros.html" class="list-group-item list-group-item-action">
                                <i class="fas fa-book me-2"></i> Livros
                            </a>
                            <a href="emprestimos.html" class="list-group-item list-group-item-action">
                                <i class="fas fa-exchange-alt me-2"></i> Empréstimos
                            </a>
                            <a href="usuarios.html" class="list-group-item list-group-item-action">
                                <i class="fas fa-users me-2"></i> Usuários
                            </a>
                            <a href="relatorios.html" class="list-group-item list-group-item-action">
                                <i class="fas fa-chart-bar me-2"></i> Relatórios
                            </a>
                            <a href="inventario.html" class="list-group-item list-group-item-action">
                                <i class="fas fa-boxes me-2"></i> Inventário
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Conteúdo da página -->
            <div class="col-12 col-lg-9 col-xl-10">
                <div class="row mb-4">
                    <div class="col-12">
                        <h2 class="mb-4">Dashboard</h2>
                    </div>
                </div>
                
                <!-- Cards de estatísticas -->
                <div class="row mb-4">
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="card shadow h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Total de Livros</h6>
                                        <h3 class="mb-0" id="totalLivros">0</h3>
                                    </div>
                                    <div class="bg-primary bg-opacity-10 p-3 rounded">
                                        <i class="fas fa-book fa-2x text-primary"></i>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span class="badge bg-success"><i class="fas fa-arrow-up"></i> 5%</span>
                                    <span class="text-muted ms-2">Desde o último mês</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="card shadow h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Empréstimos Ativos</h6>
                                        <h3 class="mb-0" id="emprestimosAtivos">0</h3>
                                    </div>
                                    <div class="bg-warning bg-opacity-10 p-3 rounded">
                                        <i class="fas fa-exchange-alt fa-2x text-warning"></i>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span class="badge bg-success"><i class="fas fa-arrow-up"></i> 12%</span>
                                    <span class="text-muted ms-2">Desde o último mês</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="card shadow h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Usuários Cadastrados</h6>
                                        <h3 class="mb-0" id="totalUsuarios">0</h3>
                                    </div>
                                    <div class="bg-info bg-opacity-10 p-3 rounded">
                                        <i class="fas fa-users fa-2x text-info"></i>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span class="badge bg-success"><i class="fas fa-arrow-up"></i> 8%</span>
                                    <span class="text-muted ms-2">Desde o último mês</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="card shadow h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Livros Atrasados</h6>
                                        <h3 class="mb-0" id="livrosAtrasados">0</h3>
                                    </div>
                                    <div class="bg-danger bg-opacity-10 p-3 rounded">
                                        <i class="fas fa-clock fa-2x text-danger"></i>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span class="badge bg-danger"><i class="fas fa-arrow-up"></i> 3%</span>
                                    <span class="text-muted ms-2">Desde o último mês</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Gráficos e tabelas -->
                <div class="row">
                    <!-- Gráfico de empréstimos -->
                    <div class="col-lg-8 mb-4">
                        <div class="card shadow">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Empréstimos por Mês</h5>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="chartOptions" data-bs-toggle="dropdown" aria-expanded="false">
                                        Este Ano
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="chartOptions">
                                        <li><a class="dropdown-item" href="#">Este Ano</a></li>
                                        <li><a class="dropdown-item" href="#">Último Ano</a></li>
                                        <li><a class="dropdown-item" href="#">Últimos 6 Meses</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height:300px;">
                                    <canvas id="emprestimosChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Categorias mais populares -->
                    <div class="col-lg-4 mb-4">
                        <div class="card shadow h-100">
                            <div class="card-header">
                                <h5 class="mb-0">Categorias Populares</h5>
                            </div>
                            <div class="card-body" id="categoriasPopulares">
                                <!-- Dados carregados dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Empréstimos recentes e livros populares -->
                <div class="row">
                    <!-- Empréstimos recentes -->
                    <div class="col-lg-7 mb-4">
                        <div class="card shadow">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Empréstimos Recentes</h5>
                                <a href="emprestimos.html" class="btn btn-sm btn-primary">Ver Todos</a>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Usuário</th>
                                                <th>Livro</th>
                                                <th>Data Empréstimo</th>
                                                <th>Data Devolução</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="emprestimosRecentes">
                                            <!-- Dados carregados dinamicamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Livros populares -->
                    <div class="col-lg-5 mb-4">
                        <div class="card shadow">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Livros Mais Populares</h5>
                                <a href="livros.html" class="btn btn-sm btn-primary">Ver Todos</a>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-shrink-0">
                                        <div class="bg-primary bg-opacity-10 p-3 rounded">
                                            <i class="fas fa-book text-primary"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">Dom Casmurro</h6>
                                        <small class="text-muted">Machado de Assis</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-primary">32 empréstimos</span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-shrink-0">
                                        <div class="bg-primary bg-opacity-10 p-3 rounded">
                                            <i class="fas fa-book text-primary"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">O Pequeno Príncipe</h6>
                                        <small class="text-muted">Antoine de Saint-Exupéry</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-primary">28 empréstimos</span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-shrink-0">
                                        <div class="bg-primary bg-opacity-10 p-3 rounded">
                                            <i class="fas fa-book text-primary"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">1984</h6>
                                        <small class="text-muted">George Orwell</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-primary">25 empréstimos</span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="bg-primary bg-opacity-10 p-3 rounded">
                                            <i class="fas fa-book text-primary"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">A Revolução dos Bichos</h6>
                                        <small class="text-muted">George Orwell</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-primary">22 empréstimos</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rodapé -->
    <footer class="mt-auto py-3">
        <div class="container text-center">
            <p class="mb-0">© 2023 SIGEB - Sistema de Gerenciamento de Biblioteca. Todos os direitos reservados.</p>
        </div>
    </footer>

    <!-- Bootstrap JS e dependências -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase -->
    <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, getDocs, collection } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    import { firebaseConfig } from './firebase-config.js';

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticação
            onAuthStateChanged(auth, function(user) {
                if (user) {
                    document.getElementById('userName').textContent = user.displayName || user.email;
                    carregarDadosDashboard();
                    inicializarGraficos();
                    implementarFiltros();
                    implementarNotificacoes();
                } else {
                    window.location.href = 'index.html';
                }
            });

            // Configurar botão de logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                signOut(auth).then(function() {
                    window.location.href = 'index.html';
                }).catch(function(error) {
                    console.error('Erro ao fazer logout:', error);
                });
            });
        });

        // Função para carregar dados do dashboard
        async function carregarDadosDashboard() {
            try {
                // Buscar total de livros
                const livrosSnap = await getDocs(collection(db, 'livros'));
                document.getElementById('totalLivros').textContent = livrosSnap.size;

                // Buscar total de usuários
                const usuariosSnap = await getDocs(collection(db, 'usuarios'));
                document.getElementById('totalUsuarios').textContent = usuariosSnap.size;

                // Criar mapas para busca rápida de usuários e livros
                const usuariosMap = new Map();
                const livrosMap = new Map();
                
                usuariosSnap.forEach(doc => {
                    const userData = doc.data();
                    usuariosMap.set(doc.id, userData.nome || userData.nomeCompleto || 'Usuário não encontrado');
                });
                
                livrosSnap.forEach(doc => {
                    const livroData = doc.data();
                    livrosMap.set(doc.id, livroData.titulo || 'Livro não encontrado');
                });

                // Buscar empréstimos ativos e atrasados
                const emprestimosSnap = await getDocs(collection(db, 'emprestimos'));
                let ativos = 0;
                let atrasados = 0;
                const hoje = new Date();
                const emprestimosRecentes = [];
                
                emprestimosSnap.forEach(doc => {
                    const data = doc.data();
                    
                    // Contar empréstimos ativos (não devolvidos)
                    if (data.status !== 'devolvido' && data.status !== 'cancelado') {
                        ativos++;
                    }
                    
                    // Contar empréstimos atrasados
                    if (data.dataDevolucao && data.status !== 'devolvido' && data.status !== 'cancelado') {
                        const dataDev = data.dataDevolucao?.toDate ? data.dataDevolucao.toDate() : new Date(data.dataDevolucao);
                        if (dataDev < hoje) {
                            atrasados++;
                        }
                    }
                    
                    // Adicionar aos empréstimos recentes com nomes dos usuários e livros
                    emprestimosRecentes.push({
                        id: doc.id,
                        ...data,
                        nomeUsuario: usuariosMap.get(data.usuarioId) || data.nomeUsuario || 'Usuário não encontrado',
                        tituloLivro: livrosMap.get(data.livroId) || data.tituloLivro || 'Livro não encontrado',
                        dataEmprestimo: data.dataEmprestimo?.toDate ? data.dataEmprestimo.toDate() : new Date(data.dataEmprestimo),
                        dataDevolucao: data.dataDevolucao?.toDate ? data.dataDevolucao.toDate() : new Date(data.dataDevolucao)
                    });
                });
                
                document.getElementById('emprestimosAtivos').textContent = ativos;
                document.getElementById('livrosAtrasados').textContent = atrasados;
                
                // Carregar empréstimos recentes na tabela
                carregarEmprestimosRecentes(emprestimosRecentes);
                
                // Carregar dados dos gráficos
                await carregarDadosGraficos();
                
                // Carregar livros populares
                await carregarLivrosPopulares();
                
            } catch (error) {
                console.error('Erro ao carregar dados do dashboard:', error);
            }
        }

        // Função para carregar empréstimos recentes
        function carregarEmprestimosRecentes(emprestimos) {
            const tbody = document.getElementById('emprestimosRecentes');
            tbody.innerHTML = '';
            
            // Ordenar por data de empréstimo (mais recentes primeiro)
            emprestimos.sort((a, b) => b.dataEmprestimo - a.dataEmprestimo);
            
            // Mostrar apenas os 5 mais recentes
            const recentesLimitados = emprestimos.slice(0, 5);
            
            recentesLimitados.forEach(emprestimo => {
                const tr = document.createElement('tr');
                const hoje = new Date();
                const dataDev = emprestimo.dataDevolucao;
                const diasRestantes = Math.ceil((dataDev - hoje) / (1000 * 60 * 60 * 24));
                
                let statusBadge = '';
                if (emprestimo.status === 'devolvido') {
                    statusBadge = '<span class="badge bg-success">Devolvido</span>';
                } else if (diasRestantes < 0) {
                    statusBadge = '<span class="badge bg-danger">Atrasado</span>';
                } else if (diasRestantes <= 3) {
                    statusBadge = '<span class="badge bg-warning">Próximo do vencimento</span>';
                } else {
                    statusBadge = '<span class="badge bg-success">Em dia</span>';
                }
                
                tr.innerHTML = `
                    <td>${emprestimo.nomeUsuario || 'N/A'}</td>
                    <td>${emprestimo.tituloLivro || 'N/A'}</td>
                    <td>${emprestimo.dataEmprestimo.toLocaleDateString('pt-BR')}</td>
                    <td>${emprestimo.dataDevolucao.toLocaleDateString('pt-BR')}</td>
                    <td>${statusBadge}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Função para carregar dados dos gráficos
        async function carregarDadosGraficos() {
            try {
                const emprestimosSnap = await getDocs(collection(db, 'emprestimos'));
                const livrosSnap = await getDocs(collection(db, 'livros'));
                
                // Criar mapa de livros para busca rápida
                const livrosMap = new Map();
                livrosSnap.forEach(doc => {
                    const livroData = doc.data();
                    livrosMap.set(doc.id, livroData.categoria || 'Outros');
                });
                
                // Dados para gráfico de empréstimos por mês
                const dadosMensais = new Array(12).fill(0);
                const categorias = {};
                
                emprestimosSnap.forEach(doc => {
                    const data = doc.data();
                    const dataEmp = data.dataEmprestimo?.toDate ? data.dataEmprestimo.toDate() : new Date(data.dataEmprestimo);
                    const mes = dataEmp.getMonth();
                    dadosMensais[mes]++;
                    
                    // Contar categorias baseado nos empréstimos
                    const categoria = livrosMap.get(data.livroId) || 'Outros';
                    categorias[categoria] = (categorias[categoria] || 0) + 1;
                });
                
                // Atualizar gráfico
                atualizarGraficoEmprestimos(dadosMensais);
                atualizarCategoriasPopulares(categorias);
                
            } catch (error) {
                console.error('Erro ao carregar dados dos gráficos:', error);
            }
        }
        
        // Função para inicializar gráficos
        function inicializarGraficos() {
            // Gráfico de empréstimos por mês
            const ctx = document.getElementById('emprestimosChart').getContext('2d');
            window.emprestimosChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                    datasets: [{
                        label: 'Empréstimos',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointBackgroundColor: 'rgba(52, 152, 219, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Função para atualizar gráfico de empréstimos
        function atualizarGraficoEmprestimos(dados) {
            if (window.emprestimosChart) {
                window.emprestimosChart.data.datasets[0].data = dados;
                window.emprestimosChart.update();
            }
        }
        
        // Função para atualizar categorias populares
        function atualizarCategoriasPopulares(categorias) {
            const container = document.getElementById('categoriasPopulares');
            if (!container) return;
            
            const total = Object.values(categorias).reduce((sum, count) => sum + count, 0);
            if (total === 0) {
                container.innerHTML = '<p class="text-muted text-center">Nenhuma categoria encontrada</p>';
                return;
            }
            
            const categoriasOrdenadas = Object.entries(categorias)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            const cores = ['bg-primary', 'bg-success', 'bg-info', 'bg-warning', 'bg-danger'];
            
            container.innerHTML = '';
            
            categoriasOrdenadas.forEach(([categoria, count], index) => {
                const percentage = Math.round((count / total) * 100);
                const isLast = index === categoriasOrdenadas.length - 1;
                
                const categoriaDiv = document.createElement('div');
                categoriaDiv.className = isLast ? '' : 'mb-3';
                
                categoriaDiv.innerHTML = `
                    <div class="d-flex justify-content-between mb-1">
                        <span>${categoria}</span>
                        <span>${percentage}%</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar ${cores[index]}" role="progressbar" 
                             style="width: ${percentage}%;" 
                             aria-valuenow="${percentage}" 
                             aria-valuemin="0" 
                             aria-valuemax="100"></div>
                    </div>
                `;
                
                container.appendChild(categoriaDiv);
            });
        }
        
        // Função para carregar livros mais populares
        async function carregarLivrosPopulares() {
            try {
                const emprestimosSnap = await getDocs(collection(db, 'emprestimos'));
                const livrosSnap = await getDocs(collection(db, 'livros'));
                
                // Contar empréstimos por livro
                const contadorLivros = {};
                
                emprestimosSnap.forEach(doc => {
                    const data = doc.data();
                    const livroId = data.livroId;
                    if (livroId) {
                        contadorLivros[livroId] = (contadorLivros[livroId] || 0) + 1;
                    }
                });
                
                // Criar mapa de livros
                const livrosMap = {};
                livrosSnap.forEach(doc => {
                    livrosMap[doc.id] = doc.data();
                });
                
                // Ordenar livros por popularidade
                const livrosPopulares = Object.entries(contadorLivros)
                    .map(([livroId, count]) => ({
                        ...livrosMap[livroId],
                        id: livroId,
                        emprestimos: count
                    }))
                    .filter(livro => livro.titulo) // Filtrar livros válidos
                    .sort((a, b) => b.emprestimos - a.emprestimos)
                    .slice(0, 4);
                
                // Atualizar a seção de livros populares
                const livrosPopularesContainer = document.querySelector('.col-lg-5 .card-body');
                if (livrosPopularesContainer && livrosPopulares.length > 0) {
                    livrosPopularesContainer.innerHTML = '';
                    
                    livrosPopulares.forEach(livro => {
                        const div = document.createElement('div');
                        div.className = 'd-flex align-items-center mb-3';
                        div.innerHTML = `
                            <div class="flex-shrink-0">
                                <div class="bg-primary bg-opacity-10 p-3 rounded">
                                    <i class="fas fa-book text-primary"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0">${livro.titulo}</h6>
                                <small class="text-muted">${livro.autor || 'Autor não informado'}</small>
                            </div>
                            <div>
                                <span class="badge bg-primary">${livro.emprestimos} empréstimos</span>
                            </div>
                        `;
                        livrosPopularesContainer.appendChild(div);
                    });
                }
                
            } catch (error) {
                console.error('Erro ao carregar livros populares:', error);
            }
        }
        
        // Função para implementar filtros de período no gráfico
        function implementarFiltros() {
            const dropdownItems = document.querySelectorAll('#chartOptions + ul .dropdown-item');
            dropdownItems.forEach(item => {
                item.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const periodo = this.textContent;
                    document.getElementById('chartOptions').textContent = periodo;
                    // Recarregar dados do gráfico baseado no período selecionado
                    await carregarDadosGraficos(periodo);
                });
            });
        }
        
        // Função para implementar sistema de notificações
        async function implementarNotificacoes() {
            try {
                const emprestimosSnap = await getDocs(collection(db, 'emprestimos'));
                const hoje = new Date();
                let notificacoes = [];
                
                emprestimosSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.status !== 'devolvido') {
                        const dataDev = data.dataDevolucao?.toDate ? data.dataDevolucao.toDate() : new Date(data.dataDevolucao);
                        const diasRestantes = Math.ceil((dataDev - hoje) / (1000 * 60 * 60 * 24));
                        
                        if (diasRestantes < 0) {
                            notificacoes.push({
                                tipo: 'danger',
                                titulo: 'Empréstimo Atrasado',
                                mensagem: `${data.nomeUsuario} - ${data.tituloLivro} (${Math.abs(diasRestantes)} dias de atraso)`,
                                prioridade: 1
                            });
                        } else if (diasRestantes <= 3) {
                            notificacoes.push({
                                tipo: 'warning',
                                titulo: 'Vencimento Próximo',
                                mensagem: `${data.nomeUsuario} - ${data.tituloLivro} (vence em ${diasRestantes} dias)`,
                                prioridade: 2
                            });
                        }
                    }
                });
                
                // Ordenar por prioridade
                notificacoes.sort((a, b) => a.prioridade - b.prioridade);
                
                // Mostrar notificações importantes
                if (notificacoes.length > 0) {
                    mostrarNotificacoes(notificacoes.slice(0, 3)); // Mostrar apenas as 3 mais importantes
                }
                
            } catch (error) {
                console.error('Erro ao carregar notificações:', error);
            }
        }
        
        // Função para mostrar notificações
        function mostrarNotificacoes(notificacoes) {
            const container = document.querySelector('.container-fluid');
            
            notificacoes.forEach((notif, index) => {
                setTimeout(() => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert alert-${notif.tipo} alert-dismissible fade show position-fixed`;
                    alertDiv.style.cssText = `
                        top: ${20 + (index * 70)}px;
                        right: 20px;
                        z-index: 1050;
                        min-width: 300px;
                        max-width: 400px;
                    `;
                    
                    alertDiv.innerHTML = `
                        <strong>${notif.titulo}:</strong> ${notif.mensagem}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    container.appendChild(alertDiv);
                    
                    // Auto-remover após 10 segundos
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 10000);
                }, index * 500); // Delay entre notificações
            });
        }
        
        // Função para atualizar dados em tempo real (opcional)
        function iniciarAtualizacaoAutomatica() {
            // Atualizar dados a cada 5 minutos
            setInterval(async () => {
                await carregarDadosDashboard();
                await implementarNotificacoes();
            }, 5 * 60 * 1000);
        }
    </script>
</body>
</html>
